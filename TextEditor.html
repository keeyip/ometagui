<!doctype html>
<html>
<head>
	<style>
		* {
			font-family: 'inconsolata-dz', 'menlo', monospace;
		}
		.text-editor {
		}
        .text-editor-line.even {
            background: hsl(0,0%,95%);
        }
        .text-editor-line {
            white-space: nowrap;
            padding: 4px 0;
        }
        .text-editor-line-indents {
            display:inline-block;
            vertical-align:top;
            white-space: nowrap;
        }
        .text-editor-line-tokens {
            display:inline-block;
            vertical-align:top;
            white-space: normal;
        }
		.text-editor-token {
			box-sizing: content-box;
			display:inline-block;
			vertical-align:top;
			text-align: center;
			height: 20px;
			font-size: 14px;
			border:solid 1px transparent;
            margin: 0;
			padding: 2px;
			background:transparent;
			outline:0;
			color: hsl(0,0%,50%);
		}
		.text-editor-token:focus {
			border:solid 1px orange;
		}
		.text-editor-token-hover,
		.text-editor-token:not(input):not([disabled]):hover {
			background: hsl(50,20%,90%);
		}
        .text-editor-indent {
            display:inline-block;
            vertical-align:top;
            width:20px;
        }
		input.text-editor-token {
			border:0;
			outline:0;
			background:hsl(0,0%,30%);
			color:white;
			width: 200px;
			transition: left 0.1s ease-out, top 0.1s ease-out;
		}

		.text-editor-token-dot {
            padding-left:0;
            padding-right:0;
		}
		.text-editor-token-space {
			color: transparent;
			min-width: 8px;
		}
		.text-editor-token-punctuation {
			color: orange;
		}
	</style>
</head>
<body>
	<script src='lib/esprima.js'></script>
	<script src='lib/underscore.js'></script>
	<script src='lib/jquery.js'></script>
	<script src='src/jquery.clickIt.js'></script>
	<script src='src/Model.js'></script>
	<script src='src/TextEditor.js'></script>
	<script src='data/BinaryHeap.js'></script>
	<script>
        var code = data_BinaryHeap.toString();
		var lines = code.split('\n')
		var ast_BinaryHeap = esprima.parse(code, {
			range: true,
			loc: true,
			tokens: true,
			comment: true,
			attachComment: true,
			tolerant: true
		});
		console.warn(ast_BinaryHeap);
		console.warn(JSON.stringify(ast_BinaryHeap.tokens[0], null, 4));
		var $editor = $('<div class="text-editor">')

		//var tokenizer = /\[|\]|\s|[a-zA-Z]+:?|\./g
		var pairs = []
        var tokenCursor = 0;
        // Esprima has duplicate tokens, it's weird.
        var visitedRanges = {};
        var tokens = _.filter(ast_BinaryHeap.tokens, function(token) {
            var key = token.range.join(',');
            if (visitedRanges[key]) return false;
            visitedRanges[key] = true;
            return true;
        });
        var buffer = [];
        console.warn('types', _.unique(_.pluck(tokens, 'type')));
        var tokenTemplate = _.template('<button data-token-value="<%- data.tokenValue %>" data-token-type="<%- data.tokenType %>" data-token-index="<%- data.tokenIndex %>" type="button" class="<%- data.extraClass %> text-editor-token"><%- data.label %></button>', null, {variable:'data'});
        var visibleLines = 0;
        var indentCount = 0;
        var indentTemplate = _.template('<span class="text-editor-indent"></span>', null, {variable:'data'});
        var INDENTERS = /^[{\[(]$/;
        var UNINDENTERS = /^[}\])]$/;
		_.each(lines, function(line, lineIndex) {
            var currentLine = lineIndex + 1;

            var lineBuffer = [];

            var makeIndentString = function() {
                return _.map(_.range(indentCount), indentTemplate).join('');
            }
            var indentStr = makeIndentString();

            var nextTokenCursor = tokenCursor;
            _.every(tokens.slice(tokenCursor), function(token, tokenIndex) {
                if (token.loc.start.line !== token.loc.end.line) {
                    console.warn('NOT IN THE SAME LINE??');
                    return false;
                }
                if (token.loc.start.line !== currentLine) {
                    return false;
                }

                var extraClass = '';
                if (token.type === 'Punctuator' && INDENTERS.test(token.value)) {
                    indentCount++;
                }
                if (token.type === 'Punctuator' && UNINDENTERS.test(token.value)) {
                    indentCount--;

                    // Unindent if the line starts with an unindenter.
                    if (lineBuffer.length <= 0) {
                        indentStr = makeIndentString();
                    }
                }

                lineBuffer.push(tokenTemplate({
                    tokenType: token.type,
                    extraClass: extraClass,
                    tokenIndex: tokenIndex,
                    tokenValue: token.value,
                    label: token.value
                }));

                /*
				else if (token[0] === '[') {
					$token.addClass('text-editor-token-pair')
					pairs.push($token)
				}
				else if (token[0] === ']') {
					$pair = pairs.pop()
						.data('$end', $token)
					$token.addClass('text-editor-token-pair')
						.data('$start', $pair)
				}
				else
					$token.addClass('text-editor-token-punctuation')
                */

                nextTokenCursor = tokenCursor + tokenIndex + 1;
                return true;
            });
            tokenCursor = nextTokenCursor;

            if (lineBuffer.length <= 0) return;

            visibleLines++;

            if (visibleLines % 2 === 0) {
                buffer.push('<div class="text-editor-line even">');
            } else {
                buffer.push('<div class="text-editor-line odd">');
            }

            buffer.push('<span class="text-editor-line-indents">' + indentStr + '</span>');

            buffer.push('<span class="text-editor-line-tokens">' + lineBuffer.join('') + '</span>');

            buffer.push('</div>');
		});

        $editor.html(buffer.join(''));

		var $input = $('<input class="text-editor-token"/>')
					.css({
						position:'absolute'
					})

		;(function() {
			var END_OF = {
				'{': '}',
				'[': ']'
			}
			var START_OF = {}
			_.each(END_OF, function(end,start) {
				START_OF[end] = start
			})

			var anyTokenPairListenMouseEnter = function() {
				$('body').one('mouseenter.anyTokenPairListenMouseEnter', '.text-editor-token-pair', function(enter) {
					console.warn('anyMouseEnter')
					var $token = $(this)
					var $start = $token.data('$start') || $token
					var $end = $token.data('$start') ? $token : $token.data('$end')
					var $pairs = $().add($start).add($end)
						.addClass('text-editor-token-hover')
					var tokenListenMouseLeave = function() {
						$token.one('mouseleave.tokenListenMouseLeave', function(leave) {
							$pairs.removeClass('text-editor-token-hover')
							anyTokenPairListenMouseEnter()
						})
					}
					tokenListenMouseLeave()
				})
			};

			anyTokenPairListenMouseEnter()
		})();

		;(function() {
			var anyTokenMethodListenClick = function() {
				var changeTimer, removeTimer, reenableTimer
				var $token = $()
				var updateValue = function() {
					var val = $.trim($input.val())
				}
				var updateAndReset = function(timeout) {
					clearTimeout(changeTimer)
					clearTimeout(reenableTimer)
					updateValue()
					$token.removeClass('text-editor-token-select')
					clearTimeout(removeTimer);

					var finish = function() {
						console.warn('Bye!')
						$input.remove();
					};

					if (!_.isNumber(timeout)) timeout = 0;

					if (timeout <= 0) {
						finish();
					} else {
						removeTimer = setTimeout(finish, timeout);
					}

					$token.prop('disabled', false);
				}

				$('body').off('.anyTokenMethodListenClick')
				$('body').on('click.anyTokenMethodListenClick', '.text-editor-token-method', function(enter) {
					console.warn('anyClick')
					$token = $(this)
						.addClass('text-editor-token-select')
						.prop('disabled', true);
					clearTimeout(removeTimer);

					console.warn($token.data('token'))
					var offset = $token.offset()
					offset.top += $token.outerHeight() + 10
					var token = $token.data('token')
					var oldValue = token[0]
					if (!$.contains(document.body, $input[0])) {
						$input.appendTo('body')
					}
					$input
						.val(oldValue)
						.offset(offset)
						.on('keydown change', function(keydown_change) {
							console.warn('keydown_change', keydown_change);
							if (keydown_change.type === 'keydown') {
								if (keydown_change.keyCode === 27 /* ESC */) {
									updateAndReset(0);
									console.warn('ESC')
									$token.focus();
									return;
								}
								if (keydown_change.keyCode === 13 /* ENTER */) {
									updateAndReset(0);
									keydown_change.preventDefault();
									console.warn('ENTER')
									$token.focus();
									return;
								}
								if (keydown_change.keyCode === 9 /* TAB */) {
									updateAndReset(0);
									$token.focus();
									console.warn('TAB')
									return;
								}
							}
							clearTimeout(changeTimer)
							changeTimer = setTimeout(updateValue, 100)
						})
						.select()
						.on('blur', function(blur) {
							updateAndReset()
							console.warn('BLUR', blur)
						})
				})
			}
			anyTokenMethodListenClick()
		})();

		$editor.appendTo('body')
	</script>
</body>
</html>

